pipeline {
    agent any
    stages{
        stage('PULL'){
            steps{
                git branch: 'dev', url: 'https://github.com/shubhamkalsait/radison-hms-reservation-app.git'
            }
        }
        stage('BUILD'){
            steps{
                sh 'mvn clean package -DskipTests'
            }
        }
        stage('TEST'){
            steps{
                withSonarQubeEnv(installationName: 'sonar', credentialsId: 'sonar-cred') {
                    sh 'mvn sonar:sonar -Dsonar.projectKey=reservation-app'
                }
            }
        }
        stage('QUALITY-GATE'){
            steps{
                timeout(10) {
                    waitForQualityGate abortPipeline: true, credentialsId: 'sonar-cred'
                }
            }
        }
        stage('DOCKER-BUILD'){
            steps{
                sh '''docker build . -t Aditya986025/radison-reservation-app:latest
                        docker push Aditya986025/radison-reservation-app:latest
                        docker rmi -f Aditya986025/radison-reservation-app:latest'''
            }
        }
        stage('DEPLOY'){
            steps{
                sh 'kubectl apply -f yaml/'
            }
        }
    }
}
